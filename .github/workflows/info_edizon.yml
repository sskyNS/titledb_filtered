name: Package and Release TitleDB

on:
  # å®šæ—¶è§¦å‘å™¨ï¼šæ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 0 * * *'[citation:5][citation:9]
  # æ‰‹åŠ¨è§¦å‘å™¨ï¼šå…è®¸ä½ åœ¨GitHubç½‘é¡µç•Œé¢ä¸Šæ‰‹åŠ¨è¿è¡Œå·¥ä½œæµ
  workflow_dispatch:[citation:1]

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Merge directories and create ZIP
        run: |
          # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
          mkdir -p temp_merge
          # å¤åˆ¶ä¸¤ä¸ªoutputç›®å½•ä¸‹çš„æ‰€æœ‰titleidæ–‡ä»¶å¤¹å†…å®¹åˆ°ä¸´æ—¶ç›®å½•
          # ä½¿ç”¨ rsync çš„ -a (å½’æ¡£) å’Œ --ignore-existing é€‰é¡¹æ¥åˆå¹¶ï¼Œé¿å…è¦†ç›–
          rsync -a --ignore-existing output/titleid/ temp_merge/ 2>/dev/null || true
          rsync -a --ignore-existing output2/titleid/ temp_merge/ 2>/dev/null || true
          
          echo "æ–‡ä»¶åˆå¹¶å®Œæˆã€‚å‡†å¤‡æ‰“åŒ…..."
          # å°†åˆå¹¶åçš„ç›®å½•æ‰“åŒ…ä¸ºZIPæ–‡ä»¶
          zip -r titleid.zip temp_merge/
          echo "ZIPåŒ…åˆ›å»ºå®Œæˆã€‚"

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          # æ›´æ–°ç°æœ‰çš„ã€æœªæ‰“æ ‡ç­¾çš„â€œlatestâ€å‘å¸ƒ
          tag_name: ""  # ä¸æŒ‡å®šç‰¹å®šæ ‡ç­¾ï¼Œæ›´æ–°æœªå…³è”æ ‡ç­¾çš„å‘å¸ƒ
          name: "TitleDB Merged Package"
          body: |
            ğŸ—“ï¸ è‡ªåŠ¨æ›´æ–°äº ${{ github.event.schedule || 'æ‰‹åŠ¨è§¦å‘' }}
            æ­¤åŒ…åˆå¹¶äº† `/output/titleid/` å’Œ `/output2/titleid/` ç›®å½•ä¸‹çš„å†…å®¹ã€‚
          # è¦†ç›–ç°æœ‰é™„ä»¶ï¼Œç¡®ä¿å§‹ç»ˆåªæœ‰ä¸€ä¸ªæ–‡ä»¶
          replace_assets: true
          files: titleid.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
