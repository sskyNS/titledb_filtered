name: Package and Release TitleDB

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Merge directories and create ZIP
        run: |
          mkdir -p temp_merge
          
          # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "output/titleid/" ]; then
            echo "æ‰¾åˆ° output/titleid/ ç›®å½•"
            # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼Œå¿½ç•¥å·²æœ‰æ–‡ä»¶ï¼ˆé¿å…é‡å¤ï¼‰
            cp -n -r output/titleid/* temp_merge/ 2>/dev/null || true
          else
            echo "è­¦å‘Š: output/titleid/ ç›®å½•ä¸å­˜åœ¨"
          fi
          
          if [ -d "output2/titleid/" ]; then
            echo "æ‰¾åˆ° output2/titleid/ ç›®å½•"
            cp -n -r output2/titleid/* temp_merge/ 2>/dev/null || true
          else
            echo "è­¦å‘Š: output2/titleid/ ç›®å½•ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥temp_mergeç›®å½•æ˜¯å¦ä¸ºç©º
          if [ -z "$(ls -A temp_merge/ 2>/dev/null)" ]; then
            echo "é”™è¯¯: temp_merge ç›®å½•ä¸ºç©ºï¼"
            echo "åˆ›å»ºç©ºçš„titleid.zip"
            touch temp_merge/README.txt
            echo "è¿™æ˜¯ç©ºçš„æ¸¸æˆæ•°æ®åº“åŒ…" > temp_merge/README.txt
          fi
          
          echo "æ–‡ä»¶åˆå¹¶å®Œæˆã€‚å‡†å¤‡æ‰“åŒ…..."
          echo "temp_mergeç›®å½•å†…å®¹:"
          ls -la temp_merge/ || echo "ç›®å½•å¯èƒ½ä¸ºç©º"
          
          # è¿›å…¥ç›®å½•åˆ›å»ºzipï¼Œé¿å…è·¯å¾„é—®é¢˜
          cd temp_merge
          zip -r ../titleid.zip .
          cd ..
          
          echo "ZIPåŒ…åˆ›å»ºå®Œæˆã€‚æ–‡ä»¶å¤§å°:"
          ls -lh titleid.zip
          
          # æ·»åŠ æ—¶é—´æˆ³åˆ°æ–‡ä»¶å
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          mv titleid.zip titleid-${TIMESTAMP}.zip
          
          # åˆ›å»ºlatest.txtæ–‡ä»¶ç”¨äºé‡å®šå‘
          echo "titleid-${TIMESTAMP}.zip" > latest.txt
          echo "æœ€æ–°æ–‡ä»¶: titleid-${TIMESTAMP}.zip"

      - name: Create or Update Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "latest-package"
          name: "Switchæ¸¸æˆä¿¡æ¯åº“ - $(date +'%Y-%m-%d %H:%M')"
          body: |
            ## ğŸ¦† çƒ¤é¸­åŒ…é£çµæœˆå½±ä¸“ç”¨æ¸¸æˆæ•°æ®åº“
            
            æ¯å°æ—¶è‡ªåŠ¨æ›´æ–°ï¼ŒåŒ…å«æ¸¸æˆæˆªå›¾ç­‰å†…å®¹ã€‚
            
            ### ğŸ“Š ç‰ˆæœ¬ä¿¡æ¯
            - **ç”Ÿæˆæ—¶é—´:** $(date +'%Y-%m-%d %H:%M:%S')
            - **ç‰ˆæœ¬æ ‡è¯†:** ${TIMESTAMP}
            - **æ–‡ä»¶å¤§å°:** $(du -h titleid-${TIMESTAMP}.zip | cut -f1)
            
            ### ğŸ“¥ ä¸‹è½½é“¾æ¥
            **å½“å‰ç‰ˆæœ¬æ–‡ä»¶:** [titleid-${TIMESTAMP}.zip](https://github.com/sskyNS/titledb_filtered/releases/download/latest-package/titleid-${TIMESTAMP}.zip)
            
            **å›ºå®šé“¾æ¥ï¼ˆå§‹ç»ˆæŒ‡å‘æœ€æ–°ç‰ˆï¼‰:**
            ```
            https://sskyNS.github.io/titledb_filtered/latest
            ```
            
            ### ğŸ“‹ åŒ…å«å†…å®¹
            æ­¤åŒ…åˆå¹¶äº†ä»¥ä¸‹ç›®å½•çš„å†…å®¹ï¼š
            - `/output/titleid/`
            - `/output2/titleid/`
            
            ---
            
            *æ³¨æ„ï¼šæ¯ä¸ªç‰ˆæœ¬çš„æ–‡ä»¶ä¸‹è½½é‡ä¼šè¢«ç‹¬ç«‹ç»Ÿè®¡ï¼Œä¸ä¼šè¢«é‡ç½®*
          draft: false
          prerelease: false
          generate_release_notes: false
          files: |
            titleid-*.zip
          # æ·»åŠ åˆ°ç°æœ‰releaseè€Œä¸æ˜¯åˆ›å»ºæ–°çš„
          append_body: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
