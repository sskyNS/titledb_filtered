name: Package and Release TitleDB

on:
  schedule:
    # 每小时运行一次（每小时的第0分钟）
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 必须赋予写权限才能更新 Release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Merge directories and create ZIP
        run: |
          mkdir -p temp_merge
          
          # 检查目录是否存在
          if [ -d "output/titleid/" ]; then
            echo "找到 output/titleid/ 目录"
            rsync -a --ignore-existing output/titleid/ temp_merge/ 2>/dev/null || true
          else
            echo "警告: output/titleid/ 目录不存在"
          fi
          
          if [ -d "output2/titleid/" ]; then
            echo "找到 output2/titleid/ 目录"
            rsync -a --ignore-existing output2/titleid/ temp_merge/ 2>/dev/null || true
          else
            echo "警告: output2/titleid/ 目录不存在"
          fi
          
          echo "文件合并完成。准备打包..."
          zip -r titleid.zip temp_merge/
          echo "ZIP包创建完成。文件大小:"
          ls -lh titleid.zip

      # [步骤] 计算历史累计下载量并更新 Body
      - name: Calculate Cumulative Downloads
        id: calc_stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. 获取当前 Release 的 JSON 信息 (如果不存在则忽略错误)
          RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/releases/tags/latest-package || echo "{}")
          
          # 2. 提取当前 titleid.zip 的下载量 (如果提取失败默认为0)
          CURRENT_COUNT=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name=="titleid.zip") | .download_count // 0')
          
          # 3. 提取 Body 中保存的历史基数 (格式: <!-- history_downloads:123 -->)
          OLD_BODY=$(echo "$RELEASE_INFO" | jq -r .body)
          if [ "$OLD_BODY" == "null" ]; then OLD_BODY=""; fi
          
          # 使用 grep 提取数字，如果没找到则设为 0
          HISTORY_BASE=$(echo "$OLD_BODY" | grep -oP '(?<=<!-- history_downloads:)[0-9]+(?= -->)' || echo "0")
          
          # 4. 计算新的历史总数
          NEW_TOTAL=$((HISTORY_BASE + CURRENT_COUNT))
          
          echo "Previous History: $HISTORY_BASE"
          echo "Current Asset Downloads: $CURRENT_COUNT"
          echo "New History Base: $NEW_TOTAL"
          
          # 5. 准备新的 Body 内容 (已修复引号并精简内容)
          BASE_TEXT="自动更新于 $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          风灵月影专用，每小时定期更新，包含游戏截图、大小、厂商等内容"
          
          # 拼接新的隐藏标签 (用于下一次累计)
          FINAL_BODY="$BASE_TEXT
          <!-- history_downloads:$NEW_TOTAL -->"
          
          # 将多行内容写入环境变量文件
          {
            echo 'NEW_RELEASE_BODY<<EOF'
            echo "$FINAL_BODY"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "latest-package"
          name: "Switch游戏信息库"
          # 使用我们计算好并包含历史数据的 Body
          body: ${{ env.NEW_RELEASE_BODY }}
          files: titleid.zip
          draft: false
          prerelease: false
          # 必须设为 true 以便覆盖旧文件
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
