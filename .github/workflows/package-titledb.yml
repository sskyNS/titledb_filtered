name: Package and Release TitleDB

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Merge directories and create ZIP
        run: |
          mkdir -p temp_merge
          
          # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "output/titleid/" ]; then
            echo "æ‰¾åˆ° output/titleid/ ç›®å½•"
            rsync -a --ignore-existing output/titleid/ temp_merge/ 2>/dev/null || true
          else
            echo "è­¦å‘Š: output/titleid/ ç›®å½•ä¸å­˜åœ¨"
          fi
          
          if [ -d "output2/titleid/" ]; then
            echo "æ‰¾åˆ° output2/titleid/ ç›®å½•"
            rsync -a --ignore-existing output2/titleid/ temp_merge/ 2>/dev/null || true
          else
            echo "è­¦å‘Š: output2/titleid/ ç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo "æ–‡ä»¶åˆå¹¶å®Œæˆã€‚å‡†å¤‡æ‰“åŒ…..."
          zip -r titleid.zip temp_merge/
          echo "ZIPåŒ…åˆ›å»ºå®Œæˆã€‚æ–‡ä»¶å¤§å°:"
          ls -lh titleid.zip

      - name: Upload to Release (ä½¿ç”¨æ ‡ç­¾)
        uses: softprops/action-gh-release@v1
        with:
          # ä½¿ç”¨å›ºå®šæ ‡ç­¾è€Œä¸æ˜¯æ— æ ‡ç­¾Release
          tag_name: "latest-package"
          name: "TitleDB Merged Package (æœ€æ–°ç‰ˆ)"
          body: |
            ğŸ—“ï¸ è‡ªåŠ¨æ›´æ–°äº ${{ github.event.schedule || 'æ‰‹åŠ¨è§¦å‘' }}
            
            æ­¤åŒ…åˆå¹¶äº†ä»¥ä¸‹ç›®å½•çš„å†…å®¹ï¼š
            - `/output/titleid/`
            - `/output2/titleid/`
            
            **æ–‡ä»¶ä¿¡æ¯ï¼š**
            - ç”Ÿæˆæ—¶é—´: ${{ github.event.head_commit.timestamp || github.run_started_at }}
            - å·¥ä½œæµè¿è¡Œ: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ğŸ“¦ æ¯æ¬¡æ›´æ–°éƒ½ä¼šæ›¿æ¢ä¹‹å‰çš„æ–‡ä»¶ã€‚
          # ä½¿ç”¨ append_body æ¥ä¿ç•™ä¹‹å‰çš„æ›´æ–°è®°å½•
          append_body: false
          # æ¯æ¬¡è¦†ç›–åŒæ ‡ç­¾çš„Release
          draft: false
          prerelease: false
          generate_release_notes: false
          files: titleid.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
