name: Package and Release TitleDB

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Merge directories and create ZIP
        run: |
          # ... åˆå¹¶ç›®å½•å’Œåˆ›å»ºzipçš„ä»£ç ä¿æŒä¸å˜ ...
          zip -r titleid.zip temp_merge/
          
          # æ·»åŠ æ—¶é—´æˆ³åˆ°æ–‡ä»¶å
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          mv titleid.zip titleid-${TIMESTAMP}.zip

      - name: Create or Update Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "latest-package"
          name: "Switchæ¸¸æˆä¿¡æ¯åº“"
          body: |
            çƒ¤é¸­åŒ…é£çµæœˆå½±ä¸“ç”¨æ¸¸æˆæ•°æ®åº“
            æ¯å°æ—¶è‡ªåŠ¨æ›´æ–°ï¼ŒåŒ…å«æ¸¸æˆæˆªå›¾ç­‰å†…å®¹ã€‚
            
            ğŸ“… æœ€æ–°ç‰ˆæœ¬: $(date +'%Y-%m-%d %H:%M:%S')
            
            **å†å²ç‰ˆæœ¬ä¸‹è½½ç»Ÿè®¡:**
            - æ€»ä¸‹è½½é‡: [æŸ¥çœ‹ç»Ÿè®¡é¡µé¢](https://github.com/sskyNS/titledb_filtered/releases/tag/latest-package)
            
            ---
            
            ### æœ€æ–°ç‰ˆæœ¬ä¸‹è½½ï¼š
            [titleid-latest.zip](https://github.com/sskyNS/titledb_filtered/releases/download/latest-package/titleid-*.zip)
            
            *æ³¨æ„ï¼šé“¾æ¥ä¸­çš„ * ä¼šè‡ªåŠ¨é‡å®šå‘åˆ°æœ€æ–°ç‰ˆæœ¬*
          draft: false
          prerelease: false
          generate_release_notes: false
          files: |
            titleid-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create redirect file
        run: |
          # è·å–æœ€æ–°çš„zipæ–‡ä»¶å
          LATEST_ZIP=$(ls -t titleid-*.zip | head -1)
          
          # åˆ›å»ºHTMLé‡å®šå‘æ–‡ä»¶
          cat > latest.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <meta http-equiv="refresh" content="0; url=https://github.com/sskyNS/titledb_filtered/releases/download/latest-package/${LATEST_ZIP}">
          </head>
          <body>
              <p>æ­£åœ¨é‡å®šå‘åˆ°æœ€æ–°ç‰ˆæœ¬... <a href="https://github.com/sskyNS/titledb_filtered/releases/download/latest-package/${LATEST_ZIP}">ç‚¹å‡»è¿™é‡Œ</a></p>
          </body>
          </html>
          EOF

      - name: Upload redirect file to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages
          keep_files: true
          file_name: latest.html
