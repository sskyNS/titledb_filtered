name: Package and Release TitleDB

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Merge directories and create ZIP
        run: |
          mkdir -p temp_merge
          
          # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "output/titleid/" ]; then
            echo "æ‰¾åˆ° output/titleid/ ç›®å½•"
            # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼Œå¿½ç•¥å·²æœ‰æ–‡ä»¶ï¼ˆé¿å…é‡å¤ï¼‰
            find output/titleid/ -type f -exec cp -n {} temp_merge/ \; 2>/dev/null || true
          else
            echo "è­¦å‘Š: output/titleid/ ç›®å½•ä¸å­˜åœ¨"
          fi
          
          if [ -d "output2/titleid/" ]; then
            echo "æ‰¾åˆ° output2/titleid/ ç›®å½•"
            find output2/titleid/ -type f -exec cp -n {} temp_merge/ \; 2>/dev/null || true
          else
            echo "è­¦å‘Š: output2/titleid/ ç›®å½•ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥temp_mergeç›®å½•æ˜¯å¦ä¸ºç©º
          if [ -z "$(ls -A temp_merge/ 2>/dev/null)" ]; then
            echo "é”™è¯¯: temp_merge ç›®å½•ä¸ºç©ºï¼åˆ›å»ºç¤ºä¾‹æ–‡ä»¶..."
            echo "è¿™æ˜¯ç©ºçš„æ¸¸æˆæ•°æ®åº“åŒ…ï¼Œè¯·æ£€æŸ¥outputå’Œoutput2ç›®å½•" > temp_merge/README.txt
          fi
          
          echo "æ–‡ä»¶åˆå¹¶å®Œæˆã€‚temp_mergeç›®å½•æ–‡ä»¶æ•°:"
          ls temp_merge/ | wc -l
          
          echo "å‡†å¤‡æ‰“åŒ…..."
          # è¿›å…¥ç›®å½•åˆ›å»ºzipï¼Œé¿å…è·¯å¾„é—®é¢˜
          cd temp_merge
          zip -r ../titleid.zip .
          cd ..
          
          echo "ZIPåŒ…åˆ›å»ºå®Œæˆã€‚æ–‡ä»¶å¤§å°:"
          ls -lh titleid.zip
          
          # æ·»åŠ æ—¶é—´æˆ³åˆ°æ–‡ä»¶å
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          mv titleid.zip titleid-${TIMESTAMP}.zip
          
          # åˆ›å»ºlatest.txtæ–‡ä»¶ç”¨äºŽé‡å®šå‘
          echo "titleid-${TIMESTAMP}.zip" > latest.txt
          echo "æœ€æ–°æ–‡ä»¶: titleid-${TIMESTAMP}.zip"
          
          # åˆ›å»ºç®€å•çš„é‡å®šå‘æ–‡ä»¶
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>TitleDB Latest File Redirect</title>
              <script>
                  // ä»ŽGitHub APIèŽ·å–æœ€æ–°æ–‡ä»¶
                  fetch('https://api.github.com/repos/sskyNS/titledb_filtered/releases/tags/latest-package')
                      .then(response => response.json())
                      .then(data => {
                          if (data.assets && data.assets.length > 0) {
                              // æŒ‰åˆ›å»ºæ—¶é—´æŽ’åºï¼ŒèŽ·å–æœ€æ–°çš„æ–‡ä»¶
                              const sortedAssets = data.assets.sort((a, b) => 
                                  new Date(b.created_at) - new Date(a.created_at)
                              );
                              const latestFile = sortedAssets[0].browser_download_url;
                              window.location.href = latestFile;
                          } else {
                              document.body.innerHTML = '<h1>No files found</h1>';
                          }
                      })
                      .catch(error => {
                          document.body.innerHTML = `<h1>Error: ${error.message}</h1>`;
                      });
              </script>
          </head>
          <body>
              <h1>Redirecting to latest TitleDB package...</h1>
              <p>If not redirected automatically, please visit:</p>
              <a id="manual-link" href="#">Manual Download</a>
          </body>
          </html>
          EOF

      - name: Create or Update Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "latest-package"
          name: "Switchæ¸¸æˆä¿¡æ¯åº“ - $(date +'%Y-%m-%d %H:%M')"
          body: |
            ## ðŸ¦† çƒ¤é¸­åŒ…é£Žçµæœˆå½±ä¸“ç”¨æ¸¸æˆæ•°æ®åº“
            
            æ¯å°æ—¶è‡ªåŠ¨æ›´æ–°ï¼ŒåŒ…å«æ¸¸æˆæˆªå›¾ç­‰å†…å®¹ã€‚
            
            ### ðŸ“Š ç‰ˆæœ¬ä¿¡æ¯
            - **ç”Ÿæˆæ—¶é—´:** $(date +'%Y-%m-%d %H:%M:%S')
            - **ç‰ˆæœ¬æ ‡è¯†:** ${TIMESTAMP}
            - **æ–‡ä»¶å¤§å°:** $(du -h titleid-${TIMESTAMP}.zip | cut -f1)
            
            ### ðŸ“¥ ä¸‹è½½é“¾æŽ¥
            **å½“å‰ç‰ˆæœ¬æ–‡ä»¶:** [titleid-${TIMESTAMP}.zip](https://github.com/sskyNS/titledb_filtered/releases/download/latest-package/titleid-${TIMESTAMP}.zip)
            
            **åŽ†å²ç‰ˆæœ¬:** [æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬](https://github.com/sskyNS/titledb_filtered/releases/tag/latest-package)
            
            ### ðŸ“‹ åŒ…å«å†…å®¹
            æ­¤åŒ…åˆå¹¶äº†ä»¥ä¸‹ç›®å½•çš„å†…å®¹ï¼š
            - `/output/titleid/`
            - `/output2/titleid/`
            
            ---
            
            *æ¯ä¸ªç‰ˆæœ¬éƒ½æœ‰ç‹¬ç«‹çš„ä¸‹è½½ç»Ÿè®¡ï¼Œä¸ä¼šè¢«é‡ç½®*
          draft: false
          prerelease: false
          generate_release_notes: false
          files: |
            titleid-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload redirect file via API (æ›¿ä»£GitHub Pages)
        run: |
          # ä½¿ç”¨GitHub APIä¸Šä¼ æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼ˆä½œä¸ºæ™®é€šæ–‡ä»¶ï¼‰
          LATEST_ZIP=$(ls -t titleid-*.zip | head -1)
          
          # åˆ›å»ºREADME.mdæ–‡ä»¶ï¼ŒåŒ…å«é‡å®šå‘ä¿¡æ¯
          cat > REDIRECT.md << EOF
          # TitleDB æœ€æ–°æ–‡ä»¶é‡å®šå‘
          
          æ­¤æ–‡ä»¶ç”¨äºŽé‡å®šå‘åˆ°æœ€æ–°çš„TitleDBåŒ…ã€‚
          
          å›ºå®šé‡å®šå‘é“¾æŽ¥ï¼ˆé€šè¿‡jsDelivr CDNï¼‰ï¼š
          \`\`\`
          https://cdn.jsdelivr.net/gh/sskyNS/titledb_filtered@latest-package/latest.txt
          \`\`\`
          
          æœ€æ–°æ–‡ä»¶ï¼š[${LATEST_ZIP}](https://github.com/sskyNS/titledb_filtered/releases/download/latest-package/${LATEST_ZIP})
          
          ## ä½¿ç”¨æ–¹æ³•
          1. è®¿é—® https://github.com/sskyNS/titledb_filtered/releases/tag/latest-package
          2. ä¸‹è½½æœ€æ–°çš„titleid-*.zipæ–‡ä»¶
          
          ## è‡ªåŠ¨æ›´æ–°
          æ­¤æ•°æ®åº“æ¯å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ã€‚
          EOF
