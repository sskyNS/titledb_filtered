name: Package and Release TitleDB

on:
  schedule:
    # 每小时运行一次（每小时的第0分钟）
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Merge directories and create ZIP
        run: |
          mkdir -p temp_merge
          
          # 检查目录是否存在
          if [ -d "output/titleid/" ]; then
            echo "找到 output/titleid/ 目录"
            rsync -a --ignore-existing output/titleid/ temp_merge/ 2>/dev/null || true
          else
            echo "警告: output/titleid/ 目录不存在"
          fi
          
          if [ -d "output2/titleid/" ]; then
            echo "找到 output2/titleid/ 目录"
            rsync -a --ignore-existing output2/titleid/ temp_merge/ 2>/dev/null || true
          else
            echo "警告: output2/titleid/ 目录不存在"
          fi
          
          echo "文件合并完成。准备打包..."
          zip -r titleid.zip temp_merge/
          echo "ZIP包创建完成。文件大小:"
          ls -lh titleid.zip

      - name: Upload to Release (使用标签)
        uses: softprops/action-gh-release@v1
        with:
          # 使用固定标签而不是无标签Release
          tag_name: "latest-package"
          name: "Switch游戏信息库"
          body: |
            烤鸭包风灵月影专用游戏数据库
            每小时自动更新，包含游戏截图等内容。
          # 使用 append_body 来保留之前的更新记录
          append_body: false
          # 每次覆盖同标签的Release
          draft: false
          prerelease: false
          generate_release_notes: false
          files: titleid.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

