name: Package and Release TitleDB

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆæ¯å°æ—¶çš„ç¬¬0åˆ†é’Ÿï¼‰
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å¿…é¡»èµ‹äºˆå†™æƒé™æ‰èƒ½æ›´æ–° Release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Merge directories and create ZIP
        run: |
          mkdir -p temp_merge
          
          # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "output/titleid/" ]; then
            echo "æ‰¾åˆ° output/titleid/ ç›®å½•"
            rsync -a --ignore-existing output/titleid/ temp_merge/ 2>/dev/null || true
          else
            echo "è­¦å‘Š: output/titleid/ ç›®å½•ä¸å­˜åœ¨"
          fi
          
          if [ -d "output2/titleid/" ]; then
            echo "æ‰¾åˆ° output2/titleid/ ç›®å½•"
            rsync -a --ignore-existing output2/titleid/ temp_merge/ 2>/dev/null || true
          else
            echo "è­¦å‘Š: output2/titleid/ ç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo "æ–‡ä»¶åˆå¹¶å®Œæˆã€‚å‡†å¤‡æ‰“åŒ…..."
          zip -r titleid.zip temp_merge/
          echo "ZIPåŒ…åˆ›å»ºå®Œæˆã€‚æ–‡ä»¶å¤§å°:"
          ls -lh titleid.zip

      # [æ–°å¢æ­¥éª¤] è®¡ç®—å†å²ç´¯è®¡ä¸‹è½½é‡å¹¶æ›´æ–° Body
      - name: Calculate Cumulative Downloads
        id: calc_stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. è·å–å½“å‰ Release çš„ JSON ä¿¡æ¯ (å¦‚æœä¸å­˜åœ¨åˆ™å¿½ç•¥é”™è¯¯)
          RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/releases/tags/latest-package || echo "{}")
          
          # 2. æå–å½“å‰ titleid.zip çš„ä¸‹è½½é‡ (å¦‚æœæå–å¤±è´¥é»˜è®¤ä¸º0)
          CURRENT_COUNT=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name=="titleid.zip") | .download_count // 0')
          
          # 3. æå– Body ä¸­ä¿å­˜çš„å†å²åŸºæ•° (æ ¼å¼: <!-- history_downloads:123 -->)
          OLD_BODY=$(echo "$RELEASE_INFO" | jq -r .body)
          if [ "$OLD_BODY" == "null" ]; then OLD_BODY=""; fi
          
          # ä½¿ç”¨ grep æå–æ•°å­—ï¼Œå¦‚æœæ²¡æ‰¾åˆ°åˆ™è®¾ä¸º 0
          HISTORY_BASE=$(echo "$OLD_BODY" | grep -oP '(?<=<!-- history_downloads:)[0-9]+(?= -->)' || echo "0")
          
          # 4. è®¡ç®—æ–°çš„å†å²æ€»æ•°
          NEW_TOTAL=$((HISTORY_BASE + CURRENT_COUNT))
          
          echo "Previous History: $HISTORY_BASE"
          echo "Current Asset Downloads: $CURRENT_COUNT"
          echo "New History Base: $NEW_TOTAL"
          
          # 5. æ¸…ç†æ—§ Body ä¸­çš„ç»Ÿè®¡æ ‡ç­¾ï¼Œå‡†å¤‡æ–°çš„ Body å†…å®¹
          # åŸºç¡€æè¿°æ–‡æœ¬
          BASE_TEXT="ğŸ—“ï¸ è‡ªåŠ¨æ›´æ–°äº $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          
          æ­¤åŒ…åˆå¹¶äº†ä»¥ä¸‹ç›®å½•çš„å†…å®¹ï¼š
          - \`/output/titleid/\`
          - \`/output2/titleid/\`
          
          **æ–‡ä»¶ä¿¡æ¯ï¼š**
          - å·¥ä½œæµè¿è¡Œ: [#$GITHUB_RUN_NUMBER]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)
          
          ğŸ“¦ æ¯æ¬¡æ›´æ–°éƒ½ä¼šæ›¿æ¢ä¹‹å‰çš„æ–‡ä»¶ã€‚
          "
          
          # æ‹¼æ¥æ–°çš„éšè—æ ‡ç­¾
          FINAL_BODY="$BASE_TEXT
          <!-- history_downloads:$NEW_TOTAL -->"
          
          # å°†å¤šè¡Œå†…å®¹å†™å…¥ç¯å¢ƒå˜é‡æ–‡ä»¶
          {
            echo 'NEW_RELEASE_BODY<<EOF'
            echo "$FINAL_BODY"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "latest-package"
          name: "TitleDB Merged Package (æœ€æ–°ç‰ˆ)"
          # ä½¿ç”¨æˆ‘ä»¬è®¡ç®—å¥½å¹¶åŒ…å«å†å²æ•°æ®çš„ Body
          body: ${{ env.NEW_RELEASE_BODY }}
          files: titleid.zip
          draft: false
          prerelease: false
          # å¿…é¡»è®¾ä¸º true ä»¥ä¾¿è¦†ç›–æ—§æ–‡ä»¶ï¼Œä½† Release é¡µé¢æœ¬èº«ä¸ä¼šè¢«åˆ é™¤é‡å»º
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
